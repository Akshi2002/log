{% extends "base.html" %}

{% block title %}Employee Login - Attendance System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <i class="fas fa-user-lock fa-3x text-primary mb-3"></i>
                    <h2 class="card-title">Employee Login</h2>
                    <p class="text-muted">Enter your Employee ID and Password to access your dashboard</p>
                </div>
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope me-2"></i>Email
                        </label>
                        <input type="email" class="form-control" id="email" name="email" 
                               placeholder="Enter your work email" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Use your registered email (Firebase Authentication)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock me-2"></i>Password
                        </label>
                        <input type="password" class="form-control" id="password" name="password" 
                               placeholder="Enter your password" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            This is your Firebase password
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                        <button type="button" id="forgotPasswordBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-unlock-alt me-2"></i>Forgot password
                        </button>
                        <button type="button" id="signupBtn" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus me-2"></i>Create account
                        </button>
                    </div>
                </form>
                
                <div class="text-center mt-4">
                    <a href="{{ url_for('employee_portal') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Portal
                    </a>
                </div>
                
                <div class="mt-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Login uses Firebase Authentication (email/password). Your email must match the employee record.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBkGq_zzIRt1rFOkdbOPTOrfolTQRG3IXk",
    authDomain: "duty-login.firebaseapp.com",
    projectId: "duty-login",
    storageBucket: "duty-login.firebasestorage.app",
    messagingSenderId: "12625177796",
    appId: "1:12625177796:web:d02f4bbc7cf8caf30c2d91",
    measurementId: "G-VNKQS710PV"
  };
  firebase.initializeApp(firebaseConfig);

  const form = document.getElementById('loginForm');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    try {
      // Firebase email/password sign-in
      const cred = await firebase.auth().signInWithEmailAndPassword(email, password);
      
      // Check if email is verified. If not, stop here.
      await cred.user.reload();
      if (!cred.user.emailVerified) {
        if (confirm('Your email is not verified. Resend verification email now?')) {
          await cred.user.sendEmailVerification();
          alert('Verification email sent. Please verify and then log in.');
        }
        await firebase.auth().signOut();
        return;
      }
      const idToken = await cred.user.getIdToken();

      // Call backend to create session (no geolocation needed for login)
      const resp = await fetch("{{ url_for('auth_session_login') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken, userType: 'employee' })
      });
      const data = await resp.json();
      if (!resp.ok || !data.success) {
        alert(data.message || 'Login failed');
        return;
      }
      window.location.href = data.redirect;
    } catch (err) {
      alert(err && err.message ? err.message : 'Login failed');
    }
  });

  // Forgot password handler
  const forgotBtn = document.getElementById('forgotPasswordBtn');
  if (forgotBtn) {
    forgotBtn.addEventListener('click', async function() {
      try {
        const email = document.getElementById('email').value.trim();
        if (!email) {
          alert('Please enter your email first.');
          return;
        }
        await firebase.auth().sendPasswordResetEmail(email);
        alert('Password reset email sent. Check your inbox.');
      } catch (err) {
        // Fallback: ask server to generate link
        try {
          const resp = await fetch("{{ url_for('auth_password_reset_link') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, continueUrl: window.location.origin + '{{ url_for('employee_login') }}' })
          });
          const data = await resp.json();
          if (resp.ok && data.success && data.link) {
            if (confirm('Could not send email automatically. Open reset link now?')) {
              window.open(data.link, '_blank');
            } else {
              navigator.clipboard && navigator.clipboard.writeText(data.link);
              alert('Reset link copied to clipboard.');
            }
          } else {
            alert((data && data.message) || (err && err.message) || 'Failed to send reset email');
          }
        } catch (e2) {
          alert((err && err.message) || 'Failed to send reset email');
        }
      }
    });
  }

  // Sign Up flow with Firebase email verification
  const signupBtn = document.getElementById('signupBtn');
  if (signupBtn) {
    signupBtn.addEventListener('click', async function() {
      try {
        // Step 1: Get email and check if employee exists
        const emailInput = document.getElementById('email').value.trim();
        const signupEmail = emailInput || prompt('Enter your work email:') || '';
        if (!signupEmail) { 
          alert('Email is required'); 
          return; 
        }
        
        // Step 2: Precheck - verify employee exists in system
        const precheckResp = await fetch("{{ url_for('auth_employee_precheck') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: signupEmail })
        });
        const precheckData = await precheckResp.json();
        
        if (!precheckResp.ok || !precheckData.success) {
          alert(precheckData.message || 'Employee not found. Contact admin.');
          return;
        }
        
        // Step 3: Explain the process BEFORE asking for password
        const confirmMsg = 'IMPORTANT: After creating your account, you will receive a verification email.\n\n' +
                          'You MUST verify your email before you can log in.\n\n' +
                          'Continue to create your account?';
        if (!confirm(confirmMsg)) {
          return;
        }
        
        // Step 4: Get password
        const password = document.getElementById('password').value || prompt('Create a password (min 6 characters):') || '';
        if (!password || password.length < 6) {
          alert('Password must be at least 6 characters');
          return;
        }
        
        // Step 5: Create Firebase Auth user
        const cred = await firebase.auth().createUserWithEmailAndPassword(signupEmail, password);
        
        // Step 6: Send Firebase email verification
        await cred.user.sendEmailVerification();
        
        // Step 7: Sign out immediately - user must verify email first
        await firebase.auth().signOut();
        
        // Step 8: Clear form and show clear instructions
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        
        alert('âœ… Account created!\n\nðŸ“§ A verification email has been sent to ' + signupEmail + 
              '\n\nâš ï¸ IMPORTANT: You MUST click the verification link in your email before you can log in.\n\n' +
              'After verifying, return here and log in with your email and password.');
        
      } catch (err) {
        if (err.code === 'auth/email-already-in-use') {
          alert('An account already exists for this email. Please login instead.');
        } else {
          alert(err && err.message ? err.message : 'Signup failed');
        }
      }
    });
  }
</script>
{% endblock %} 