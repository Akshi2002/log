{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-center" style="min-height: 85vh;">
  <div class="w-100" style="max-width: 1100px;">
    <div class="shadow" style="border-radius: 30px; overflow: hidden; background: #ffffff;">
      <div class="row g-0">
        <div class="col-md-6 p-5 d-flex align-items-center">
          <div class="w-100" style="max-width: 420px; margin: 0 auto;">
            <h3 class="mb-4 text-center fw-bold">Welcome!</h3>
            <form method="POST" id="unifiedLoginForm" action="{{ url_for('login') }}">
              <div class="mb-3">
                <input type="text" class="form-control" id="username" name="username" placeholder="email" required>
              </div>
              <div class="mb-2">
                <input type="password" class="form-control" id="password" name="password" placeholder="password" required>
              </div>
              <input type="hidden" name="latitude" id="latitude">
              <input type="hidden" name="longitude" id="longitude">
              <div class="d-grid mt-3">
                <button type="submit" class="btn" id="loginBtn" style="background:#2d2d2d; color:#ffffff; border-radius: 14px; padding: 12px 18px;">Login</button>
              </div>
            </form>
            <div class="text-center mt-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="signupBtn" onclick="handleSignup()" style="border-radius: 14px; padding: 8px 16px;">
                <span id="signupText">Sign Up</span>
                <span id="signupLoading" style="display:none;">Loading...</span>
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6 position-relative d-none d-md-block p-0" style="background: #000;">
          <img src="{{ url_for('static', filename='images/Login.jpg') }}" alt="Login" style="width:100%; height:100%; min-height:520px; object-fit: cover; opacity: 0.9;">
          <div class="position-absolute" style="right: 24px; bottom: 18px; color: #ffffff; text-align: right;">
            <div class="fw-semibold">Employee Portal</div>
            <small>for NhanceGRC, Thinkways.ai, GDC</small>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</div>

<script type="application/json" id="firebase-config">{{ firebase_web_config | tojson }}</script>
<script>
  // Global signup function (available immediately)
  window.handleSignup = function() {
    console.log('Signup button clicked');
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) {
      alert('Please enter email and password');
      return;
    }
    
    // Show loading
    document.getElementById('signupText').style.display = 'none';
    document.getElementById('signupLoading').style.display = 'inline';
    document.getElementById('signupBtn').disabled = true;
    
    // Wait for Firebase to load (with timeout)
    var attempts = 0;
    var checkFirebase = function() {
      attempts++;
      if (typeof firebase !== 'undefined' && firebase.auth) {
        console.log('Firebase loaded, attempting signup');
        firebase.auth().createUserWithEmailAndPassword(email, password)
          .then(function(cred){ 
            console.log('Signup successful');
            alert('Account created successfully! You can now login.');
            // Auto-login after signup
            firebase.auth().signInWithEmailAndPassword(email, password)
              .then(function(cred){ return cred.user.getIdToken(); })
              .then(function(idToken){
                return fetch("{{ url_for('session_login') }}", {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ idToken: idToken })
                });
              })
              .then(function(r){ return r.json(); })
              .then(function(data){
                if (data.redirect) { window.location.href = data.redirect; }
                else if (data.error) { alert(data.error); }
              })
              .catch(function(err){ var msg = (err && err.message) ? err.message : String(err); alert('Login failed: ' + msg); });
          })
          .catch(function(err){ 
            console.log('Signup error:', err);
            var msg = (err && err.message) ? err.message : String(err); 
            alert('Signup failed: ' + msg); 
          })
          .finally(function(){
            // Reset button
            document.getElementById('signupText').style.display = 'inline';
            document.getElementById('signupLoading').style.display = 'none';
            document.getElementById('signupBtn').disabled = false;
          });
      } else if (attempts < 20) {
        setTimeout(checkFirebase, 500); // Check every 500ms
      } else {
        alert('Firebase failed to load. Please refresh the page and try again.');
        // Reset button
        document.getElementById('signupText').style.display = 'inline';
        document.getElementById('signupLoading').style.display = 'none';
        document.getElementById('signupBtn').disabled = false;
      }
    };
    
    checkFirebase();
  };

  // Firebase Web SDK - Email/Password sign-in then session
  (function(){
    var cfgEl = document.getElementById('firebase-config');
    var cfg = null;
    try { cfg = cfgEl ? JSON.parse(cfgEl.textContent) : null; } catch(e) { cfg = null; }
    
    console.log('Firebase config:', cfg);
    
    if (!cfg || !cfg.apiKey || cfg.apiKey === 'your_api_key_here') {
      console.log('Firebase config not found or invalid, using fallback login');
      alert('Firebase configuration is missing or invalid. Please check your .env file.');
      return; // skip if not configured
    }
    
    const s1 = document.createElement('script');
    s1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
    const s2 = document.createElement('script');
    s2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js';
    document.head.appendChild(s1);
    document.head.appendChild(s2);
    
    s2.onload = function(){
      try {
        firebase.initializeApp(cfg);
        const auth = firebase.auth();
        const form = document.getElementById('unifiedLoginForm');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        
        console.log('Firebase initialized successfully');
        
        // Handle login
        form.addEventListener('submit', function(e){
          e.preventDefault();
          const email = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value.trim();
          console.log('Attempting login for:', email);
          auth.signInWithEmailAndPassword(email, password)
            .then(function(cred){ return cred.user.getIdToken(); })
            .then(function(idToken){
              return fetch("{{ url_for('session_login') }}", {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken })
              });
            })
            .then(function(r){ return r.json(); })
            .then(function(data){
              if (data.redirect) { window.location.href = data.redirect; }
              else if (data.error) { alert(data.error); }
            })
            .catch(function(err){ var msg = (err && err.message) ? err.message : String(err); alert('Login failed: ' + msg); });
        });
        
        // Firebase is now loaded, update the global function
        window.handleSignup = function() {
          console.log('Signup button clicked (Firebase loaded)');
          const email = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value.trim();
          if (!email || !password) {
            alert('Please enter email and password');
            return;
          }
          console.log('Attempting signup for:', email);
          auth.createUserWithEmailAndPassword(email, password)
            .then(function(cred){ 
              console.log('Signup successful');
              alert('Account created successfully! You can now login.');
              // Auto-login after signup
              auth.signInWithEmailAndPassword(email, password)
                .then(function(cred){ return cred.user.getIdToken(); })
                .then(function(idToken){
                  return fetch("{{ url_for('session_login') }}", {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken: idToken })
                  });
                })
                .then(function(r){ return r.json(); })
                .then(function(data){
                  if (data.redirect) { window.location.href = data.redirect; }
                  else if (data.error) { alert(data.error); }
                })
                .catch(function(err){ var msg = (err && err.message) ? err.message : String(err); alert('Login failed: ' + msg); });
            })
            .catch(function(err){ 
              console.log('Signup error:', err);
              var msg = (err && err.message) ? err.message : String(err); 
              alert('Signup failed: ' + msg); 
            });
        };
      } catch (error) {
        console.log('Firebase initialization error:', error);
        alert('Firebase initialization failed. Please check your configuration.');
      }
    };
    
    s2.onerror = function() {
      console.log('Failed to load Firebase Auth script');
      alert('Failed to load Firebase. Please check your internet connection.');
    };
  })();

  // Try to capture geolocation (best effort, non-blocking) - COMMENTED OUT
  // (function(){
  //   const latInput = document.getElementById('latitude');
  //   const lonInput = document.getElementById('longitude');
  //   if (navigator.geolocation) {
  //     navigator.geolocation.getCurrentPosition(function(pos){
  //       latInput.value = pos.coords.latitude;
  //       lonInput.value = pos.coords.longitude;
  //     }, function(){}, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 });
  //   }
  // })();
</script>
{% endblock %}


