{% extends "base.html" %}

{% block title %}Admin Login - Attendance System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <i class="fas fa-user-shield fa-3x text-primary mb-3"></i>
                    <h2 class="card-title">Admin Login</h2>
                    <p class="text-muted">Enter your credentials to access the admin panel</p>
                </div>
                
                <form id="adminLoginForm">
                    <div class="mb-3">
                        <label for="admin_email" class="form-label">
                            <i class="fas fa-envelope me-2"></i>Email
                        </label>
                        <input type="email" class="form-control" id="admin_email" name="admin_email" 
                               placeholder="Enter your admin email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock me-2"></i>Password
                        </label>
                        <input type="password" class="form-control" id="password" name="password" 
                               placeholder="Enter your password" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                        <button type="button" id="adminForgotPasswordBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-unlock-alt me-2"></i>Forgot password
                        </button>
                    </div>
                </form>
                
                <div class="text-center mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-home me-2"></i>Back to Home
                    </a>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Admin login uses Firebase Authentication. Your email must correspond to an admin username.
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBkGq_zzIRt1rFOkdbOPTOrfolTQRG3IXk",
    authDomain: "duty-login.firebaseapp.com",
    projectId: "duty-login",
    storageBucket: "duty-login.firebasestorage.app",
    messagingSenderId: "12625177796",
    appId: "1:12625177796:web:d02f4bbc7cf8caf30c2d91",
    measurementId: "G-VNKQS710PV"
  };
  if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }

  const form = document.getElementById('adminLoginForm');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('admin_email').value.trim();
    const password = document.getElementById('password').value;
    try {
      const cred = await firebase.auth().signInWithEmailAndPassword(email, password);
      const idToken = await cred.user.getIdToken();
      const resp = await fetch("{{ url_for('auth_session_login') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken, userType: 'admin' })
      });
      const data = await resp.json();
      if (!resp.ok || !data.success) {
        alert(data.message || 'Login failed');
        return;
      }
      window.location.href = data.redirect;
    } catch (err) {
      alert(err && err.message ? err.message : 'Login failed');
    }
  });

  // Forgot password for admin
  const adminForgotBtn = document.getElementById('adminForgotPasswordBtn');
  if (adminForgotBtn) {
    adminForgotBtn.addEventListener('click', async function() {
    try {
      const email = document.getElementById('admin_email').value.trim();
      if (!email) {
        alert('Please enter your admin email first.');
        return;
      }
      await firebase.auth().sendPasswordResetEmail(email);
      alert('Password reset email sent. Check your inbox.');
    } catch (err) {
      // Fallback via server-generated link
      try {
        const resp = await fetch("{{ url_for('auth_password_reset_link') }}", {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, continueUrl: window.location.origin + '{{ url_for('admin_login') }}' })
        });
        const data = await resp.json();
        if (resp.ok && data.success && data.link) {
          if (confirm('Could not send email automatically. Open reset link now?')) {
            window.open(data.link, '_blank');
          } else {
            navigator.clipboard && navigator.clipboard.writeText(data.link);
            alert('Reset link copied to clipboard.');
          }
        } else {
          alert((data && data.message) || (err && err.message) || 'Failed to send reset email');
        }
      } catch (e2) {
        alert((err && err.message) || 'Failed to send reset email');
      }
    }
    });
  }
</script>
{% endblock %} 